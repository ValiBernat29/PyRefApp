# templates/matches.html - Enhanced Match Management Template with Referee Display
{% extends "base.html" %}

{% block title %}Matches - Referee Assignment System{% endblock %}

{% block content %}
<h2 class="section-title"><i class="fas fa-futbol"></i> Match Management</h2>

<div class="row mb-4">
    <div class="col-md-6">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMatchModal">
            <i class="fas fa-plus"></i> Schedule Match
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Teams</th>
                        <th>League</th>
                        <th>Referee Assignments</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match_data in matches %}
                        <tr>
                            <td>{{ match_data.match.date }}</td>
                            <td>
                                <strong>{{ match_data.team1.name }}</strong>
                                <small class="text-muted">vs</small>
                                <strong>{{ match_data.team2.name }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ match_data.league.name }}</span>
                            </td>
                            <td>
                                {% if match_data.assignments|length == 0 %}
                                    <button class="btn btn-sm btn-primary" onclick="openAssignReferees({{ match_data.match.id }})">
                                        <i class="fas fa-plus"></i> Assign Referees
                                    </button>
                                {% else %}
                                    <div class="referee-assignments">
                                        {% for assignment in match_data.assignments %}
                                            <div class="referee-assignment mb-1">
                                                <span class="badge {% if assignment.role == 'Referee' %}bg-success{% else %}bg-info{% endif %} me-1">
                                                    {{ assignment.role|replace('Assistant ', 'Asst. ') }}
                                                </span>
                                                <small>{{ assignment.referee.first_name }} {{ assignment.referee.last_name }}</small>
                                                <small class="text-muted">(Cat {{ assignment.referee.category }})</small>
                                            </div>
                                        {% endfor %}
                                        <button class="btn btn-sm btn-outline-warning mt-1" onclick="reassignReferees({{ match_data.match.id }})">
                                            <i class="fas fa-edit"></i> Reassign
                                        </button>
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMatch({{ match_data.match.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Match Modal -->
<div class="modal fade" id="addMatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule New Match</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMatchForm">
                    <div class="mb-3">
                        <label class="form-label">League</label>
                        <select class="form-control" name="league" id="match-league" onchange="updateTeamOptions()" required>
                            <option value="">Select League</option>
                            {% for league in leagues %}
                                <option value="{{ league.id }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Team 1</label>
                                <select class="form-control" name="team1" id="match-team1" required>
                                    <option value="">Select Team 1</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Team 2</label>
                                <select class="form-control" name="team2" id="match-team2" required>
                                    <option value="">Select Team 2</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Match Date</label>
                        <input type="date" class="form-control" name="date" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addMatch()">Schedule Match</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Referees Modal -->
<div class="modal fade" id="assignRefereesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Referees</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignRefereesForm">
                    <input type="hidden" name="matchId" id="assign-match-id">
                    <div class="mb-4">
                        <h6 id="assign-match-info" class="text-primary"></h6>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-whistle text-success"></i> Main Referee
                        </label>
                        <select class="form-control" name="referee" id="assign-referee" required>
                            <option value="">Select Main Referee</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-flag text-info"></i> Assistant Referee 1
                        </label>
                        <select class="form-control" name="assistant1" id="assign-assistant1" required>
                            <option value="">Select Assistant Referee 1</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-flag text-info"></i> Assistant Referee 2
                        </label>
                        <select class="form-control" name="assistant2" id="assign-assistant2" required>
                            <option value="">Select Assistant Referee 2</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <small><i class="fas fa-info-circle"></i> Only referees available on the match date are shown.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="assignReferees()">Assign Referees</button>
            </div>
        </div>
    </div>
</div>

<!-- Reassign Referees Modal -->
<div class="modal fade" id="reassignRefereesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Reassign Referees</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> This will replace all current referee assignments for this match.
                </div>
                <form id="reassignRefereesForm">
                    <input type="hidden" name="matchId" id="reassign-match-id">
                    <div class="mb-4">
                        <h6 id="reassign-match-info" class="text-primary"></h6>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-whistle text-success"></i> Main Referee
                        </label>
                        <select class="form-control" name="referee" id="reassign-referee" required>
                            <option value="">Select Main Referee</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-flag text-info"></i> Assistant Referee 1
                        </label>
                        <select class="form-control" name="assistant1" id="reassign-assistant1" required>
                            <option value="">Select Assistant Referee 1</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-flag text-info"></i> Assistant Referee 2
                        </label>
                        <select class="form-control" name="assistant2" id="reassign-assistant2" required>
                            <option value="">Select Assistant Referee 2</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="performReassign()">Reassign Referees</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateTeamOptions() {
    const leagueId = document.getElementById('match-league').value;
    const team1Select = document.getElementById('match-team1');
    const team2Select = document.getElementById('match-team2');

    team1Select.innerHTML = '<option value="">Select Team 1</option>';
    team2Select.innerHTML = '<option value="">Select Team 2</option>';

    if (leagueId) {
        fetch(`/api/leagues/${leagueId}/teams`)
        .then(response => response.json())
        .then(teams => {
            teams.forEach(team => {
                const option1 = new Option(team.name, team.id);
                const option2 = new Option(team.name, team.id);
                team1Select.add(option1);
                team2Select.add(option2);
            });
        });
    }
}

function addMatch() {
    const form = document.getElementById('addMatchForm');
    const formData = new FormData(form);

    const data = {
        leagueId: formData.get('league'),
        team1Id: formData.get('team1'),
        team2Id: formData.get('team2'),
        date: formData.get('date')
    };

    fetch('/api/matches', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function openAssignReferees(matchId) {
    document.getElementById('assign-match-id').value = matchId;

    // Get match info and available referees
    Promise.all([
        fetch(`/api/matches/${matchId}/available-referees`),
        // We'll get match info from the page context for now
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([refereesData]) => {
        populateRefereeSelects('assign', refereesData);

        const modal = new bootstrap.Modal(document.getElementById('assignRefereesModal'));
        modal.show();
    })
    .catch(error => {
        alert('Error loading available referees: ' + error.message);
    });
}

function reassignReferees(matchId) {
    document.getElementById('reassign-match-id').value = matchId;

    // Get available referees for reassignment
    fetch(`/api/matches/${matchId}/available-referees`)
    .then(response => response.json())
    .then(data => {
        populateRefereeSelects('reassign', data);

        const modal = new bootstrap.Modal(document.getElementById('reassignRefereesModal'));
        modal.show();
    })
    .catch(error => {
        alert('Error loading available referees: ' + error.message);
    });
}

function populateRefereeSelects(prefix, data) {
    const refereeSelect = document.getElementById(`${prefix}-referee`);
    const assistant1Select = document.getElementById(`${prefix}-assistant1`);
    const assistant2Select = document.getElementById(`${prefix}-assistant2`);

    refereeSelect.innerHTML = '<option value="">Select Main Referee</option>';
    assistant1Select.innerHTML = '<option value="">Select Assistant Referee 1</option>';
    assistant2Select.innerHTML = '<option value="">Select Assistant Referee 2</option>';

    data.mainReferees.forEach(ref => {
        const option = new Option(`${ref.first_name} ${ref.last_name} (Cat ${ref.category})`, ref.id);
        refereeSelect.add(option);
    });

    data.assistants.forEach(ref => {
        const option1 = new Option(`${ref.first_name} ${ref.last_name} (Cat ${ref.category})`, ref.id);
        const option2 = new Option(`${ref.first_name} ${ref.last_name} (Cat ${ref.category})`, ref.id);
        assistant1Select.add(option1);
        assistant2Select.add(option2);
    });
}

function assignReferees() {
    const form = document.getElementById('assignRefereesForm');
    const formData = new FormData(form);
    const matchId = formData.get('matchId');

    const data = {
        refereeId: formData.get('referee'),
        assistant1Id: formData.get('assistant1'),
        assistant2Id: formData.get('assistant2')
    };

    fetch(`/api/matches/${matchId}/assign`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function performReassign() {
    // First delete existing assignments, then create new ones
    const form = document.getElementById('reassignRefereesForm');
    const formData = new FormData(form);
    const matchId = formData.get('matchId');

    const data = {
        refereeId: formData.get('referee'),
        assistant1Id: formData.get('assistant1'),
        assistant2Id: formData.get('assistant2')
    };

    // For now, we'll use the same assign endpoint
    // In a full implementation, you'd want a separate reassign endpoint
    fetch(`/api/matches/${matchId}/reassign`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(() => {
        // Fallback: just reload the page and let user try again
        alert('Please refresh the page and try reassigning again.');
        location.reload();
    });
}

function deleteMatch(id) {
    if (confirm('Are you sure you want to delete this match? This will also remove all referee assignments.')) {
        fetch(`/api/matches/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}
</script>
{% endblock %}